# سرور ارسال نامه SMTP خود را بسازید

## مقدمه

SMTP می تواند مستقیماً خدماتی را از فروشندگان ابری خریداری کند، مانند:

* [آمازون SES SMTP](https://docs.aws.amazon.com/ses/latest/dg/send-email-smtp.html)
* [فشار ایمیل علی ابری](https://www.alibabacloud.com/help/directmail/latest/three-mail-sending-methods)

شما همچنین می توانید سرور ایمیل خود را بسازید - ارسال نامحدود، هزینه کلی کم.

در زیر، ما گام به گام نحوه ساخت سرور ایمیل خود را نشان می دهیم.

## انتخاب سرور

سرور SMTP خود میزبان به یک IP عمومی با پورت های 25، 456 و 587 باز نیاز دارد.

ابرهای عمومی پرکاربرد به صورت پیش فرض این پورت ها را مسدود کرده اند و شاید بتوان با صدور دستور کار آنها را باز کرد، اما به هر حال بسیار دردسرساز است.

من خرید از میزبانی را توصیه می کنم که این پورت ها را باز کرده و از تنظیم نام دامنه معکوس پشتیبانی می کند.

در اینجا، من [Contabo را](https://contabo.com) توصیه می کنم.

Contabo یک ارائه دهنده هاست مستقر در مونیخ آلمان است که در سال 2003 با قیمت های بسیار رقابتی تاسیس شد.

اگر یورو را به عنوان ارز خرید انتخاب کنید، قیمت ارزان تر خواهد بود (سرور با حافظه 8 گیگابایتی و 4 سی پی یو حدود 529 یوان در سال هزینه دارد و هزینه نصب اولیه برای یک سال رایگان است).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/UoAQkwY.webp)

هنگام ثبت سفارش، `prefer AMD` دهید و سرور با CPU AMD عملکرد بهتری خواهد داشت.

در ادامه، VPS Contabo را به عنوان مثال می‌آورم تا نشان دهم چگونه می‌توانید سرور ایمیل خود را بسازید.

## پیکربندی سیستم اوبونتو

سیستم عامل اینجا اوبونتو 22.04 است

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/smpIu1F.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/m7Mwjwr.webp)

اگر سرور در ssh نمایش داده می شود `Welcome to TinyCore 13!` (همانطور که در شکل زیر نشان داده شده است) یعنی سیستم هنوز نصب نشده است. لطفاً ssh را قطع کنید و چند دقیقه صبر کنید تا دوباره وارد شوید.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/-qKACz9.webp)

هنگامی که `Welcome to Ubuntu 22.04.1 LTS` ظاهر می شود، مقداردهی اولیه کامل شده است و می توانید مراحل زیر را ادامه دهید.

### [اختیاری] محیط توسعه را راه اندازی کنید

این مرحله اختیاری است.

برای راحتی کار، نصب و پیکربندی سیستم نرم افزار ubuntu را در [github.com/wactax/ops.os/tree/main/ubuntu](https://github.com/wactax/ops.os/tree/main/ubuntu) قرار دادم.

دستور زیر را برای نصب با یک کلیک اجرا کنید.

```
bash <(curl -s https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

کاربران چینی لطفاً به جای آن از دستور زیر استفاده کنید و زبان، منطقه زمانی و غیره به طور خودکار تنظیم می شود.

```
CN=1 bash <(curl -s https://ghproxy.com/https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

### Contabo IPV6 را فعال می کند

IPV6 را فعال کنید تا SMTP همچنین بتواند ایمیل هایی با آدرس IPV6 ارسال کند.

`/etc/sysctl.conf` را ویرایش کنید

خطوط زیر را اصلاح یا اضافه کنید

```
net.ipv6.conf.all.disable_ipv6 = 0
net.ipv6.conf.default.disable_ipv6 = 0
net.ipv6.conf.lo.disable_ipv6 = 0
```

[آموزش contabo را دنبال کنید: افزودن اتصال IPv6 به سرور شما](https://contabo.com/blog/adding-ipv6-connectivity-to-your-server/)

`/etc/netplan/01-netcfg.yaml` را ویرایش کنید، همانطور که در شکل زیر نشان داده شده است چند خط اضافه کنید (فایل پیکربندی پیش‌فرض Contabo VPS از قبل دارای این خطوط است، فقط کافی است آنها را از نظر خارج کنید).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/5MEi41I.webp)

سپس `netplan apply` تا پیکربندی اصلاح شده اعمال شود.

پس از موفقیت آمیز بودن پیکربندی، می توانید از `curl 6.ipw.cn` برای مشاهده آدرس ipv6 شبکه خارجی خود استفاده کنید.

## عملیات مخزن پیکربندی را کلون کنید

```
git clone https://github.com/wactax/ops.soft.git
```

## یک گواهی SSL رایگان برای نام دامنه خود ایجاد کنید

ارسال نامه به گواهی SSL برای رمزگذاری و امضا نیاز دارد.

ما از [acme.sh](https://github.com/acmesh-official/acme.sh) برای تولید گواهی استفاده می کنیم.

acme.sh یک ابزار امضای گواهی خودکار منبع باز است،

وارد تنظیمات warehouse ops.soft شوید، `./ssl.sh` را اجرا کنید و یک پوشه `conf` در **دایرکتوری بالایی** ایجاد خواهد شد.

ارائه دهنده DNS خود را از [acme.sh dnsapi](https://github.com/acmesh-official/acme.sh/wiki/dnsapi) پیدا کنید، `conf/conf.sh` را ویرایش کنید.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Qjq1C1i.webp)

سپس `./ssl.sh 123.com` اجرا کنید تا گواهینامه های `123.com` و `*.123.com` برای نام دامنه شما ایجاد شود.

اولین اجرا به طور خودکار [acme.sh را](https://github.com/acmesh-official/acme.sh) نصب می کند و یک کار برنامه ریزی شده برای تمدید خودکار اضافه می کند. می توانید `crontab -l` ببینید، چنین خطی به شرح زیر وجود دارد.

```
52 0 * * * "/mnt/www/.acme.sh"/acme.sh --cron --home "/mnt/www/.acme.sh" > /dev/null
```

مسیر گواهی تولید شده چیزی شبیه `/mnt/www/.acme.sh/123.com_ecc。`

تمدید گواهی اسکریپت `conf/reload/123.com.sh` را فراخوانی می کند، این اسکریپت را ویرایش کنید، می توانید دستوراتی مانند `nginx -s reload` اضافه کنید تا حافظه پنهان گواهی برنامه های مرتبط را به روز کنید.

## ساخت سرور SMTP با chasquid

[chasquid](https://github.com/albertito/chasquid) یک سرور SMTP منبع باز است که به زبان Go نوشته شده است.

به عنوان جایگزینی برای برنامه های سرور پست الکترونیکی قدیمی مانند Postfix و Sendmail، chasquid ساده تر و آسان تر برای استفاده است، و همچنین برای توسعه ثانویه آسان تر است.

اجرای `./chasquid/init.sh 123.com` به طور خودکار با یک کلیک نصب می شود (نام دامنه ارسالی خود را جایگزین 123.com کنید).

## پیکربندی امضای ایمیل DKIM

DKIM برای ارسال امضای ایمیل استفاده می شود تا از تلقی نامه ها به عنوان هرزنامه جلوگیری شود.

پس از اجرای موفقیت آمیز دستور، از شما خواسته می شود رکورد DKIM را تنظیم کنید (مانند شکل زیر).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/LJWGsmI.webp)

فقط یک رکورد TXT به DNS خود اضافه کنید (مانند شکل زیر).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/0szKWqV.webp)

## مشاهده وضعیت خدمات و سیاهههای مربوط

 `systemctl status chasquid` مشاهده وضعیت سرویس.

وضعیت عملکرد عادی مطابق شکل زیر می باشد

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/CAwyY4E.webp)

 `grep chasquid /var/log/syslog` یا `journalctl -xeu chasquid` می‌تواند گزارش خطا را مشاهده کند.

## معکوس کردن پیکربندی نام دامنه

نام دامنه معکوس اجازه می دهد تا آدرس IP به نام دامنه مربوطه حل شود.

تنظیم نام دامنه معکوس می تواند از شناسایی ایمیل ها به عنوان هرزنامه جلوگیری کند.

هنگامی که نامه دریافت می شود، سرور دریافت کننده تجزیه و تحلیل نام دامنه معکوس را روی آدرس IP سرور ارسال کننده انجام می دهد تا تأیید کند که آیا سرور فرستنده نام دامنه معکوس معتبری دارد یا خیر.

اگر سرور ارسال کننده نام دامنه معکوس نداشته باشد یا اگر نام دامنه معکوس با آدرس IP سرور ارسال کننده مطابقت نداشته باشد، سرور دریافت کننده ممکن است ایمیل را به عنوان هرزنامه تشخیص دهد یا آن را رد کند.

از [https://my.contabo.com/rdns](https://my.contabo.com/rdns) دیدن کنید و مطابق شکل زیر پیکربندی کنید

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/IIPdBk_.webp)

پس از تنظیم نام دامنه معکوس، به یاد داشته باشید که رزولوشن فوروارد نام دامنه ipv4 و ipv6 را به سرور پیکربندی کنید.

## نام میزبان chasquid.conf را ویرایش کنید

`conf/chasquid/chasquid.conf` به مقدار نام دامنه معکوس تغییر دهید.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/6Fw4SQi.webp)

سپس `systemctl restart chasquid` اجرا کنید تا سرویس راه اندازی مجدد شود.

## پشتیبان گیری از conf در مخزن git

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Fier9uv.webp)

به عنوان مثال، من از پوشه conf به صورت زیر در فرآیند github خودم نسخه پشتیبان تهیه می کنم

ابتدا یک انبار خصوصی ایجاد کنید

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ZSCT1t1.webp)

وارد دایرکتوری conf شده و به انبار ارسال کنید

```
git init
git add .
git commit -m "init"
git branch -M main
git remote add origin git@github.com:wac-tax-key/conf.git
git push -u origin main
```

## افزودن فرستنده

اجرا کن

```
chasquid-util user-add i@wac.tax
```

می تواند فرستنده را اضافه کند

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/khHjLof.webp)

### بررسی کنید که رمز عبور به درستی تنظیم شده باشد

```
chasquid-util authenticate i@wac.tax --password=xxxxxxx
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/e92JHXq.webp)

پس از افزودن کاربر، `chasquid/domains/wac.tax/users` به ​​روز می شود، به یاد داشته باشید که آن را به انبار ارسال کنید.

## DNS رکورد SPF را اضافه می کند

SPF (Sender Policy Framework) یک فناوری تأیید ایمیل است که برای جلوگیری از کلاهبرداری ایمیل استفاده می شود.

با بررسی اینکه آدرس IP فرستنده با سوابق DNS نام دامنه ای که ادعا می کند مطابقت دارد هویت فرستنده نامه را تأیید می کند و از ارسال ایمیل های جعلی توسط کلاهبرداران جلوگیری می کند.

افزودن رکوردهای SPF می تواند تا حد امکان از شناسایی ایمیل ها به عنوان هرزنامه جلوگیری کند.

اگر سرور نام دامنه شما از نوع SPF پشتیبانی نمی کند، فقط رکورد نوع TXT را اضافه کنید.

برای مثال SPF `wac.tax` به صورت زیر است

`v=spf1 a mx include:_spf.wac.tax include:_spf.google.com ~all`

SPF برای `_spf.wac.tax`

`v=spf1 a:smtp.wac.tax ~all`

توجه داشته باشید که من در اینجا `include:_spf.google.com` ، زیرا بعداً `i@wac.tax` به عنوان آدرس ارسال در صندوق پستی Google پیکربندی خواهم کرد.

## پیکربندی DNS DMARC

DMARC مخفف (Domain-based Message Authentication, Reporting & Conformance) است.

از آن برای گرفتن پرش های SPF استفاده می شود (ممکن است ناشی از خطاهای پیکربندی باشد یا شخص دیگری وانمود کند که شما برای ارسال هرزنامه هستید).

رکورد TXT `_dmarc` را اضافه کنید،

مطالب به شرح زیر است

```
v=DMARC1; p=quarantine; fo=1; ruf=mailto:ruf@wac.tax; rua=mailto:rua@wac.tax
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/k44P7O3.webp)

معنی هر پارامتر به شرح زیر است

### p (خط مشی)

نحوه رسیدگی به ایمیل هایی را نشان می دهد که تأیید SPF (چارچوب خط مشی فرستنده) یا DKIM (ایمیل شناسایی شده با کلیدهای دامنه) را انجام نمی دهند. پارامتر p را می توان روی یکی از سه مقدار تنظیم کرد:

* هیچ: هیچ اقدامی انجام نمی شود، فقط نتیجه تأیید از طریق مکانیسم گزارش ایمیل به فرستنده بازخورد داده می شود.
* قرنطینه: نامه‌ای را که تأیید نشده است را در پوشه اسپم قرار دهید، اما مستقیماً نامه را رد نمی‌کند.
* رد کردن: مستقیماً ایمیل هایی را که تأیید نمی شوند رد کنید.

### fo (گزینه های شکست)

مقدار اطلاعات بازگردانده شده توسط مکانیسم گزارش را مشخص می کند. می توان آن را به یکی از مقادیر زیر تنظیم کرد:

* 0: نتایج تأیید اعتبار را برای همه پیام ها گزارش کنید
* 1: فقط پیام هایی را گزارش کنید که تأیید نشدند
* د: فقط خرابی های تأیید نام دامنه را گزارش کنید
* s: فقط خرابی های تأیید SPF را گزارش کنید
* l: فقط خرابی های تأیید DKIM را گزارش کنید

### روآ و روف

* rua (گزارش URI برای گزارش‌های انبوه): آدرس ایمیل برای دریافت گزارش‌های انبوه
* ruf (گزارش URI برای گزارش های پزشکی قانونی): آدرس ایمیل برای دریافت گزارش های دقیق

## رکوردهای MX را برای ارسال ایمیل به Google Mail اضافه کنید

از آنجایی که نتوانستم صندوق پستی شرکتی رایگانی پیدا کنم که از آدرس‌های جهانی پشتیبانی کند (Catch-All، می‌تواند هر ایمیلی را که به این نام دامنه ارسال می‌شود، بدون محدودیت در پیشوندها دریافت کند)، از chasquid برای بازارسال همه ایمیل‌ها به صندوق پستی Gmail خود استفاده کردم.

**اگر صندوق پستی تجاری پولی خود را دارید، لطفاً MX را تغییر ندهید و از این مرحله بگذرید.**

ویرایش `conf/chasquid/domains/wac.tax/aliases` ، تنظیم صندوق پستی باز ارسال

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/OBDl2gw.webp)

`*` همه ایمیل ها را نشان می دهد، `i` پیشوند آدرس ایمیل کاربر فرستنده ایجاد شده در بالا است. برای ارسال نامه، هر کاربر باید یک خط اضافه کند.

سپس رکورد MX را اضافه کنید (مستقیماً به آدرس نام دامنه معکوس در اینجا اشاره می کنم، همانطور که در خط اول در شکل زیر نشان داده شده است).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/7__KrU8.webp)

پس از تکمیل پیکربندی، می‌توانید از آدرس‌های ایمیل دیگر برای ارسال ایمیل به `i@wac.tax` و `any123@wac.tax` استفاده کنید تا ببینید آیا می‌توانید ایمیل‌ها را در Gmail دریافت کنید یا خیر.

اگر نه، گزارش chasquid را بررسی کنید ( `grep chasquid /var/log/syslog` ).

## با Google Mail به i@wac.tax ایمیل بفرستید

بعد از اینکه Google Mail نامه را دریافت کرد، طبیعتاً امیدوار بودم که به جای i.wac.tax@gmail.com با `i@wac.tax` پاسخ دهم.

از [https://mail.google.com/mail/u/1/#settings/accounts](https://mail.google.com/mail/u/1/#settings/accounts) دیدن کنید و روی «افزودن یک آدرس ایمیل دیگر» کلیک کنید.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/PAvyE3C.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/_OgLsPT.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/XIUf6Dc.webp)

سپس، کد تأیید دریافت شده توسط ایمیلی که به آن فوروارد شده است را وارد کنید.

در نهایت، می توان آن را به عنوان آدرس فرستنده پیش فرض (به همراه گزینه پاسخ با همان آدرس) تنظیم کرد.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/a95dO60.webp)

به این ترتیب استقرار میل سرور SMTP را تکمیل کرده ایم و در عین حال از Google Mail برای ارسال و دریافت ایمیل استفاده می کنیم.

## برای بررسی موفقیت آمیز بودن پیکربندی، یک ایمیل آزمایشی ارسال کنید

`ops/chasquid` را وارد کنید

اجرای `direnv allow` نصب وابستگی ها را می دهد (direnv در فرآیند اولیه سازی یک کلید قبلی نصب شده است و یک قلاب به پوسته اضافه شده است)

سپس اجرا کنید

```
user=i@wac.tax pass=xxxx to=iuser.link@gmail.com ./sendmail.coffee
```

معنی پارامترها به شرح زیر است

* کاربر: نام کاربری SMTP
* پاس: رمز عبور SMTP
* به: گیرنده

می توانید یک ایمیل آزمایشی ارسال کنید.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ae1iWyM.webp)

توصیه می شود از جیمیل برای دریافت ایمیل های آزمایشی برای بررسی موفقیت آمیز بودن پیکربندی ها استفاده کنید.

### رمزگذاری استاندارد TLS

همانطور که در شکل زیر نشان داده شده است، این قفل کوچک وجود دارد که به این معنی است که گواهی SSL با موفقیت فعال شده است.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/SrdbAwh.webp)

سپس روی "نمایش ایمیل اصلی" کلیک کنید

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/qQQsdxg.webp)

### DKIM

همانطور که در شکل زیر نشان داده شده است، صفحه ایمیل اصلی Gmail DKIM را نشان می دهد، که به این معنی است که پیکربندی DKIM با موفقیت انجام شده است.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/an6aXK6.webp)

Received را در هدر ایمیل اصلی بررسی کنید، می بینید که آدرس فرستنده IPV6 است، یعنی IPV6 نیز با موفقیت پیکربندی شده است.
